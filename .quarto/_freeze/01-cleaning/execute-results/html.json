{
  "hash": "8de7e421e65bbf012823f2c6d61f78ae",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Cleaning\"\n---\n\n\n## Setting up the project \n\nHere I am loading the special libraries I need in order to clean my data. For this specific project I will need rvest and httr2 in order to pull out data that is not readily available for me to download.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.4.4     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(janitor)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'janitor'\n\nThe following objects are masked from 'package:stats':\n\n    chisq.test, fisher.test\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(rvest)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'rvest'\n\nThe following object is masked from 'package:readr':\n\n    guess_encoding\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(httr2)\n```\n:::\n\n\n## Getting the html \n\nBecause I can't directly load the data into my computer, here I will get the html that I want to scrape the data from.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# url <- \"https://planestrategico.conl.mx/indicadores/detalle/ods/242/datos?page\"\nurl <- \"https://planestrategico.conl.mx/indicadores/detalle/ods/242/datos?page=2\"\n\nhtml <- read_html(url)\n```\n:::\n\n\nI am asking the function to specifically scrape for information in a table format. To be able to identify what I need, I used the inspector function in my computer browser. To start I want to look at the index of climate change awareness of each state, or how responsible state entities are of their natural resources. This includes water efficiency, deforestation protection and much more. States are graded on a scale from 0 to 100, where the higher the score the better the better the performance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntables <- html |> html_table()\n\ntables[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 4\n   `UNIDAD GEOGRÁFICA STR` VALOR   AÑO `CVE UNIDAD GEOGRÁFICA`\n   <chr>                   <dbl> <int>                   <int>\n 1 Nuevo León               57.6  2011                      19\n 2 Baja California          60.3  2011                       2\n 3 Oaxaca                   28.0  2011                      20\n 4 Puebla                   49.4  2011                      21\n 5 Querétaro                59.7  2011                      22\n 6 Quintana Roo             45.8  2011                      23\n 7 San Luis Potosí          35.2  2011                      24\n 8 Sinaloa                  55.6  2011                      25\n 9 Sonora                   52.0  2011                      26\n10 Tabasco                  28.4  2011                      27\n```\n\n\n:::\n\n```{.r .cell-code}\ntables |> _[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 4\n   `UNIDAD GEOGRÁFICA STR` VALOR   AÑO `CVE UNIDAD GEOGRÁFICA`\n   <chr>                   <dbl> <int>                   <int>\n 1 Nuevo León               57.6  2011                      19\n 2 Baja California          60.3  2011                       2\n 3 Oaxaca                   28.0  2011                      20\n 4 Puebla                   49.4  2011                      21\n 5 Querétaro                59.7  2011                      22\n 6 Quintana Roo             45.8  2011                      23\n 7 San Luis Potosí          35.2  2011                      24\n 8 Sinaloa                  55.6  2011                      25\n 9 Sonora                   52.0  2011                      26\n10 Tabasco                  28.4  2011                      27\n```\n\n\n:::\n:::\n\n\nThis is now a list of tibbles not a tibble. \n\n## Spanish terminology\n\nThe first variable \"UNIDAD GEOGRÁFICA STR\" refers to the geographical region of each entity in the variable list, in this case the data is evaluated at the state level. \n\n\"VALOR\" stands for value. \n\n\"AÑO\"stands for year, which is also shown as \"ano\". \n\n\"CVE UNIDAD GRÁFICA\" represents different numbers assigned to each state. For example, the state of Nuevo León is number 19. We will largely ignore these variables in this analysis. \n\n## Function to parse page \n\nHere we parse the page by using a function. This is also cleaning the names and making sure that they are easier for me to work with.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparse_page <- function(our_url) {\n  our_url |> \n    read_html() |> \n    html_table() |> _[[1]] |> \n    clean_names() |> \n    mutate(valor = valor |> as.character() |> parse_number())\n}\n\n# We test this by feeding it the url variable we also used above here is the function\nparse_page(url)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 4\n   unidad_geografica_str valor   ano cve_unidad_geografica\n   <chr>                 <dbl> <int>                 <int>\n 1 Nuevo León             57.6  2011                    19\n 2 Baja California        60.3  2011                     2\n 3 Oaxaca                 28.0  2011                    20\n 4 Puebla                 49.4  2011                    21\n 5 Querétaro              59.7  2011                    22\n 6 Quintana Roo           45.8  2011                    23\n 7 San Luis Potosí        35.2  2011                    24\n 8 Sinaloa                55.6  2011                    25\n 9 Sonora                 52.0  2011                    26\n10 Tabasco                28.4  2011                    27\n```\n\n\n:::\n:::\n\n\nIn the function we also added the parse.number() in the function to ensure that it reads every valor variable as a number and not a character. \n\n## Get and combine the pages \n\nThis is where I get the data. The data is not just from the main page table, but all tables in the same url.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This range has to be valid. See how many pages are in the table\ni <- 1:39\n\n# This creates a list of urls based on that range\nurls <- str_glue(\"https://planestrategico.conl.mx/indicadores/detalle/ods/242/datos?page={i}\")\n\n# This takes that list of urls and then runs our parse_page() function on each one.\n# The result is a list tibbles, i.e., a table from each page\nrequests <- map(urls, parse_page)\n\n# list_rbind is a special function that binds a list of tibbles into a single one\nclimate_data <- requests |> list_rbind() \n\n# here we just peek at the table\nclimate <- climate_data |> mutate(source= \"climate\")\n\nclimate\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 384 × 5\n   unidad_geografica_str valor   ano cve_unidad_geografica source \n   <chr>                 <dbl> <int>                 <int> <chr>  \n 1 Aguascalientes         69.6  2011                     1 climate\n 2 Durango                49.6  2011                    10 climate\n 3 Guanajuato             54.7  2011                    11 climate\n 4 Guerrero               32.0  2011                    12 climate\n 5 Hidalgo                37.7  2011                    13 climate\n 6 Jalisco                63.8  2011                    14 climate\n 7 México                 55.7  2011                    15 climate\n 8 Michoacán              47.9  2011                    16 climate\n 9 Morelos                58.1  2011                    17 climate\n10 Nayarit                53.6  2011                    18 climate\n# ℹ 374 more rows\n```\n\n\n:::\n:::\n\n\nWe take all the pages that we want. In this example we have all 39 pages of data scraped. I also attributed these specific variables to the name \"climate\" to be able to identify what we are looking at. \n\n## Adding more data from other variables\n\nNow I want to add other variables so that later I can form a more complete analysis. I added to my data the percentage of water insecurity by each Mexican state. I named this variable water_insecurity. \n\nHere is the same process with the url for water_insecurity:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This range has to be valid. See how many pages are in the table\ni <- 1:7\n\n# This creates a list of urls based on that range\nurls <- str_glue(\"https://planestrategico.conl.mx/indicadores/detalle/ods/934/datos?page={i}\")\n\n# This takes that list of urls and then runs our parse_page() function on each one.\n# The result is a list tibbles, i.e., a table from each page\nrequests <- map(urls, parse_page)\n\n# list_rbind is a special function that binds a list of tibbles into a single one\nwater_insecurity_data <- requests |> list_rbind()\n\n# here we just peek at the table\nwater_insecurity <- water_insecurity_data |> \n  mutate(source = \"water_insecurity\")\n\nwater_insecurity\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 66 × 5\n   unidad_geografica_str valor   ano cve_unidad_geografica source          \n   <chr>                 <dbl> <int>                 <int> <chr>           \n 1 Nacional              15.4   2021                     0 water_insecurity\n 2 Aguascalientes        17.4   2021                     1 water_insecurity\n 3 Durango                9.33  2021                    10 water_insecurity\n 4 Guanajuato             8.72  2021                    11 water_insecurity\n 5 Guerrero              26.1   2021                    12 water_insecurity\n 6 Hidalgo               16.0   2021                    13 water_insecurity\n 7 Jalisco               21.6   2021                    14 water_insecurity\n 8 México                24.2   2021                    15 water_insecurity\n 9 Michoacán             20.4   2021                    16 water_insecurity\n10 Morelos               19.3   2021                    17 water_insecurity\n# ℹ 56 more rows\n```\n\n\n:::\n:::\n\n\nNotice how the only element that changes in the url is the attached number in the source variable.\n\nNow I want to add the data for average annual availability of groundwater. This variable is in units of millions of cubic meters per year. This also takes into account the amount of water that can be used in many ways without harming the environment with its extraction. I called this variable groundwater for simplicity. \n\nHere is the data pulled for groundwater: \n\n\n::: {.cell}\n\n```{.r .cell-code}\ni <- 1:7\n\nurls <- str_glue(\"https://planestrategico.conl.mx/indicadores/detalle/ods/122/datos?page={i}\")\n\nrequests <- map(urls, parse_page)\n\ngroundwater_data <- requests |> list_rbind()\n\ngroundwater <- groundwater_data |> \n  mutate(source = \"groundwater\")\n\ngroundwater\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 64 × 5\n   unidad_geografica_str  valor   ano cve_unidad_geografica source     \n   <chr>                  <dbl> <int>                 <int> <chr>      \n 1 Aguascalientes        -108.   2018                     1 groundwater\n 2 Durango                 30    2018                    10 groundwater\n 3 Guanajuato            -465.   2018                    11 groundwater\n 4 Guerrero               762.   2018                    12 groundwater\n 5 Hidalgo                236.   2018                    13 groundwater\n 6 Jalisco               -246.   2018                    14 groundwater\n 7 México                -350.   2018                    15 groundwater\n 8 Michoacán              228.   2018                    16 groundwater\n 9 Morelos                 37.2  2018                    17 groundwater\n10 Nayarit                 93.3  2018                    18 groundwater\n# ℹ 54 more rows\n```\n\n\n:::\n:::\n\n\nNow I will add data that looks at the number of hectares reforested by year in each state. This looks specifically at reforestation efforts. I called this variable reforestation. \n\nHere is the data pulled for reforestation: \n\n\n::: {.cell}\n\n```{.r .cell-code}\ni <- 1:53\n\nurls <- str_glue(\"https://planestrategico.conl.mx/indicadores/detalle/ods/135/datos?page={i}\")\n\nrequests <- map(urls, parse_page)\n\nreforestation_data <- requests |> list_rbind()\n\nreforestation <- reforestation_data |> \n  mutate(source = \"reforestation\")\n\nreforestation\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 528 × 5\n   unidad_geografica_str   valor   ano cve_unidad_geografica source       \n   <chr>                   <dbl> <int>                 <int> <chr>        \n 1 Nacional              14513.   1993                     0 reforestation\n 2 Aguascalientes          123.   1993                     1 reforestation\n 3 Durango                 648.   1993                    10 reforestation\n 4 Guanajuato               42.8  1993                    11 reforestation\n 5 Guerrero                737.   1993                    12 reforestation\n 6 Hidalgo                 285.   1993                    13 reforestation\n 7 Jalisco                 316.   1993                    14 reforestation\n 8 México                  734    1993                    15 reforestation\n 9 Michoacán               802.   1993                    16 reforestation\n10 Morelos                 982.   1993                    17 reforestation\n# ℹ 518 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\n## Combine the data \n\nIn order to export and analyze my data I combined all of the variables together. Since they all have the same table format, it was easy to make each one match up. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_the_data <- bind_rows(climate, \n water_insecurity, groundwater, reforestation)\n\nall_the_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,042 × 5\n   unidad_geografica_str valor   ano cve_unidad_geografica source \n   <chr>                 <dbl> <int>                 <int> <chr>  \n 1 Aguascalientes         69.6  2011                     1 climate\n 2 Durango                49.6  2011                    10 climate\n 3 Guanajuato             54.7  2011                    11 climate\n 4 Guerrero               32.0  2011                    12 climate\n 5 Hidalgo                37.7  2011                    13 climate\n 6 Jalisco                63.8  2011                    14 climate\n 7 México                 55.7  2011                    15 climate\n 8 Michoacán              47.9  2011                    16 climate\n 9 Morelos                58.1  2011                    17 climate\n10 Nayarit                53.6  2011                    18 climate\n# ℹ 1,032 more rows\n```\n\n\n:::\n:::\n\n\nNow I have all the data filter source in place, and with the source name I can differentiate and tell what each number means. \n\n## Exporing the data \n\nI will export my cleaned data to a folder. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_the_data |> write_rds(\"data-processed/01-finaldata.rds\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}